var startTime,endTime,taskTimeout,tester_id,current_task,task_completion_array,re_counter=0;function getTimeOffset(){var t=(endTime=new Date)-startTime;return t/=1e3,Math.round(t)}function addCancelButton(){$(".logo > img").attr("src",window.browser.runtime.getURL("img/icon_big_white.png")),$("#usability_testing_addon_cancel").click(function(){confirm("Wollen Sie diesen Usability-Test wirklich abbrechen? Ihre Ergebnisse werden nicht gespeichert! Weitermachen?")&&(clearTimeout(taskTimeout),removeOverlay(),window.browser.runtime.sendMessage({reason:"endCountdown",cancelTest:!0},function(t){}))})}function displayToast(t,e,i){console.log("display toast",e),$("#usability_testing_addon_overlay_toast").attr("style","").html("<h3>"+t+"</h3><p>"+e+"</p>"),setTimeout(function(){$("#usability_testing_addon_overlay_toast").attr("style","transform: scale(1) !important; opacity: 1 !important"),i>0&&setTimeout(function(){$("#usability_testing_addon_overlay_toast").attr("style","transform: scale(0) !important; opacity: 0 !important")},i)},0)}function removeOverlay(){$("#usability_testing_addon_overlay").remove()}function reinstateTask(t,e,i,n){var a;($("<button class='logo_button medium usability_testing_addon_cancel_task' id='usability_testing_addon_cancel_task_"+t.id+"' style='color: #ffffff !important; padding: 5px 7px !important; z-index: 16777271 !important; position: fixed !important; text-align: right !important;width: 125px !important; height: 30px !important; top: 10px !important; right: 9px !important; font-size: 15px !important;'><img src='"+window.browser.runtime.getURL("img/cancel.svg")+"' alt=''><span>Abbrechen</span></button>").appendTo("body"),setTimeout(function(){$(".usability_testing_addon_cancel_task").click(function(){$(this).remove(),task_completion_array[t.id]=!0,clearTimeout(taskTimeout),n(!1,0)})},1e3),re_counter++,startTime=null!=i?new Date(i):new Date,"no_limit"!==t.time)&&(null!=i?(startTime=new Date(i),a=getTimeOffset()):a=0,a<0&&(a=0),console.log("offset = ",a," remaining secs",1e3*(parseInt(t.time)-a)),taskTimeout=setTimeout(function(){console.log("Out of time"),task_completion_array[t.id]?n(null,0,!0):(window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),task_completion_array[t.id]=!0,$("#usability_testing_addon_cancel_task_"+t.id).remove(),task_completion_array[t.id]=!0,n(!1,0))},1e3*(parseInt(t.time)-a)));if("css_id"===t.target.target_type)$("#"+t.target.target_css_ids.join(", #")).bind("click.usabilityTestHandler",function(){if(task_completion_array[t.id])n(null,0,!0);else{$("#usability_testing_addon_cancel_task_"+t.id).remove();let e=getTimeOffset();window.broswser.runtime.sendMessage({reason:"endCountdown"},function(t){}),clearTimeout(taskTimeout),task_completion_array[t.id]=!0,n(!0,e)}});else if("both"===t.target.target_type&&t.target.target_urls.includes(window.location.href))$("#"+t.target.target_css_ids.join(", #")).bind("click.usabilityTestHandler",function(){if(task_completion_array[t.id])n(null,0,!0);else{$("#usability_testing_addon_cancel_task_"+t.id).remove(),window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),clearTimeout(taskTimeout);let e=getTimeOffset();task_completion_array[t.id]=!0,n(!0,e)}});else if("url"===t.target.target_type&&t.target.target_urls.includes(window.location.href))if(task_completion_array[t.id])n(null,0,!0);else{let e=getTimeOffset();console.log("final calcs",e,i),window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),clearTimeout(taskTimeout),task_completion_array[t.id]=!0,n(!0,e)}}function displayStart(t){$("<div id='usability_testing_addon_overlay' style='opacity: 0  !important; background-color: rgba(50, 50, 50, 0.97) !important;  z-index: 16777270 !important; position: fixed !important; width: 100vw !important; height: 100vh !important; top: 0 !important; left: 0 !important;'><div class='usability_testing_addon_logo'><img src='"+window.browser.runtime.getURL("img/icon_big_white.png")+"' alt='logo'><span>Usability Test</span></div><div style='font-size: 24px  !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; text-align: center !important; width: 80% !important; color: white !important;'>Geben Sie Ihren Name oder ID ein<br/><input type='text' placeholder='Name oder ID' id='usability_testing_addon_identification'><br/><br/><button id='usability_testing_addon_take_test' class='logo_button'> <img alt='' src='"+window.browser.runtime.getURL("img/next.svg")+"'/><span>Usability Test starten!</span></button></div><span id='usability_testing_addon_cancel' style='padding: 6px 7px !important; z-index: 16777271 !important; position: fixed !important; text-align: right !important; width: 50px !important; height: 50px !important; top: 15px !important; right: 30px !important; font-size: 50px !important;'>X</span></div>").appendTo("body"),addCancelButton(),setTimeout(function(){$("#usability_testing_addon_overlay").css("transition","opacity 0.25s ease-out").css("opacity","1")},0),$("#usability_testing_addon_take_test").click(function(){tester_id=$("#usability_testing_addon_identification").val(),removeOverlay(),t()})}function displayTask(t,e,i){console.log("the remaining time is ",e),$("<div id='usability_testing_addon_overlay' style='background-color: rgba(50, 50, 50, 0.97) !important; z-index: 16777270 !important; position: fixed !important; width: 100vw !important; height: 100vh !important; top: 0 !important; left: 0 !important;'><div class='usability_testing_addon_logo'><img src='"+window.browser.runtime.getURL("img/icon_big_white.png")+"' alt='logo'><span>Usability Test</span></div><div style='font-size: 24px !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; text-align: center !important; width: 80% !important;color: white !important;'> <p class='usability_testing_addon_task_instruction'>"+t.instruction+"</p>"+("no_limit"===t.time?"":"<p class='usability_testing_addon_task_time_limit'>("+t.time+" Sekunden)</p>")+"<br/><br/><button class='usability_testing_addon_start_task logo_button' id='usability_testing_addon_start_task_"+t.id+"'><img alt='' src='"+window.browser.runtime.getURL("img/next.svg")+"'/><span>Start!</span></button></div><span id='usability_testing_addon_cancel' style='padding: 6px 7px !important; z-index: 16777271 !important; position: fixed !important; text-align: right !important; width: 50px !important; height: 50px !important; top: 15px !important; right: 50px !important; font-size: 50px !important;'>X</span></div>").appendTo("body"),addCancelButton(),$("#usability_testing_addon_start_task_"+t.id).click(function(){var n;("css_id"===t.target.target_type?$("#"+t.target.target_css_ids.join(", #")).bind("click.usabilityTestHandler",function(){if(task_completion_array[t.id])i(null,0,!0);else{window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),$(this).unbind("click.usabilityTestHandler"),$("#usability_testing_addon_cancel_task_"+t.id).remove(),task_completion_array[t.id]=!0;let e=getTimeOffset();i(!0,e),clearTimeout(taskTimeout)}}):"both"===t.target.target_type&&t.target.target_urls.includes(window.location.href)?$("#"+t.target.target_css_ids.join(", #")).bind("click.usabilityTestHandler",function(){if(task_completion_array[t.id])i(null,0,!0);else{window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),$(this).unbind("click.usabilityTestHandler"),$("#usability_testing_addon_cancel_task_"+t.id).remove(),task_completion_array[t.id]=!0;let e=getTimeOffset();i(!0,e),clearTimeout(taskTimeout)}}):"url"===t.target.target_type&&t.target.target_urls.includes(window.location.href)&&(task_completion_array[t.id]?i(null,0,!0):setTimeout(function(){window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),$("#usability_testing_addon_cancel_task_"+t.id).remove(),$(".usability_testing_addon_cancel_task").remove(),task_completion_array[t.id]=!0,clearTimeout(taskTimeout),i(!0,0)},250)),t.target.target_urls.includes(window.location.href),removeOverlay(),$("<button class='logo_button medium usability_testing_addon_cancel_task' id='usability_testing_addon_cancel_task_"+t.id+"' style='color: #ffffff !important; padding: 5px 7px !important; z-index: 16777271 !important; position: fixed !important; text-align: right !important;width: 125px !important; height: 30px !important; top: 10px !important; right: 9px !important; font-size: 15px !important;'><img src='"+window.browser.runtime.getURL("img/cancel.svg")+"' alt=''><span>Abbrechen</span></button>").appendTo("body"),$("#usability_testing_addon_cancel_task_"+t.id).click(function(){window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),$("#usability_testing_addon_cancel_task_"+t.id).remove(),clearTimeout(taskTimeout),task_completion_array[t.id]=!0,i(!1,0)}),clearTimeout(taskTimeout),"no_limit"!==t.time)&&(null!=e?(startTime=new Date(e),n=getTimeOffset()):(window.browser.runtime.sendMessage({reason:"startCountdown"},function(t){}),n=0),n<0&&(window.browser.runtime.sendMessage({reason:"startCountdown"},function(t){}),n=0),console.log("offset = ",n," remaining secs",1e3*(parseInt(t.time)-n)),taskTimeout=setTimeout(function(){task_completion_array[t.id]?i(null,0,!0):(window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),$("#usability_testing_addon_cancel_task_"+t.id).remove(),task_completion_array[t.id]=!0,i(!1,0))},1e3*(parseInt(t.time)-n)))})}function displayTaskResult(t,e,i,n){setTimeout(function(){$("#usability_testing_addon_cancel_task_"+t.id).remove()},10),clearTimeout(taskTimeout),$("<div id='usability_testing_addon_overlay' style='opacity; 0  !important; background-color: rgba(50, 50, 50, 0.97) !important; z-index: 16777270 !important; position: fixed !important; width: 100vw !important; height: 100vh !important; top: 0 !important; left: 0 !important;'><div class='usability_testing_addon_logo'><img src='"+window.browser.runtime.getURL("img/icon_big_white.png")+"' alt='logo'><span>Usability Test</span></div><div style='font-size: 24px !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; text-align: center !important; width: 80% !important;color: white !important;'>"+(e?"<p class='usability_testing_addon_task_success'>Aufgabe wurde erfolgreich abgeschlossen!</p> Sie brauchten "+i+" Sekunden.<br/>":"<p class='usability_testing_addon_task_success'>Aufgabe wurde nicht erfolgreich abgeschlossen!</p>")+"<br/>Wo gab es Probleme mit der Aufgabe? War die Aufgabe zu leicht oder zu schwer?<br/> Bitte hinterlassen Sie einen Kommentar:<br/><textarea style='width: 474px !important; height: 164px !important; margin-bottom: 15px !important; margin-top: 20px !important; background-color: white !important; text-align: left !important; border-radius: 5px !important;' id='usability_testing_addon_comment'></textarea><br/><button class='usability_testing_addon_conclude_task logo_button' id='usability_testing_addon_conclude_task_"+t.id+"'><img alt='' src='"+window.browser.runtime.getURL("img/next.svg")+"'/><span>Aufgabe abschließen!</span></button></div><span id='usability_testing_addon_cancel' style='padding: 6px 7px !important; z-index: 16777271 !important; position: fixed !important; text-align: right !important; width: 50px !important; height: 50px !important; top: 15px !important; right: 30px !important; font-size: 50px !important;'>X</span></div>").appendTo("body"),setTimeout(function(){$("#usability_testing_addon_overlay").css("transition","opacity 0.25s ease-out").css("opacity","1")},0),$("#usability_testing_addon_conclude_task_"+t.id).click(function(){n($("#usability_testing_addon_comment").val()),removeOverlay()}),$(".usability_testing_addon_cancel_task").remove(),addCancelButton()}function displayResults(t,e,i,n,a){if(clearTimeout(taskTimeout),setTimeout(function(){$(".usability_testing_addon_cancel_task").remove(),$("#usability_testing_addon_cancel").remove()},250),t.length!==e.length&&alert("Ein unerwarteter Fehler ist aufgetreten! Bitte versuchen Sie es erneut."),n){var s="<table id='usability_testing_addon_results_table'><tr><th>Aufgabe</th><th>Erfolgreich</th><th>Gebrauchte Zeit</th><th>Zeit Limit</th><th>Kommentar</th></tr>";for(let i=0;i<e.length;i++)s+="<tr><td>"+t[i].task+"</td><td>"+(t[i].success?"Ja":"Nein")+"</td><td>"+(t[i].success?t[i].timeTaken:"-")+"</td><td>"+("no_limit"===e[i].time?"-":e[i].time)+"</td><td>"+(void 0===t[i].comment?"-":t[i].comment)+"</td></tr>";s+="</table>",$("<section id=\"usability_testing_addon_overlay_toast\">\n    <h3>Message sent!</h3>\n    <p>Thanks for getting in touch with me!<br/>\n        I will get back to you as soon possible.</p>\n</section><div id='usability_testing_addon_overlay' style='background-color: rgba(50, 50, 50, 0.97) !important;  z-index: 16777270 !important; position: fixed !important; width: 100vw !important; height: 100vh !important; top: 0 !important; left: 0 !important;'><div class='usability_testing_addon_logo'><img src='"+window.browser.runtime.getURL("img/icon_big_white.png")+"' alt='logo'><span>Usability Test</span></div><div style='overflow-x: auto !important; font-size: 24px !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; text-align: center !important; width: 80% !important; color: white !important;'>"+s+"<button id='usability_testing_addon_send_result_email' class='logo_button'><img alt='' src='"+window.browser.runtime.getURL("img/cursor.svg")+"'/><span>Ergebnisse zurücksenden</span></button><button id='usability_testing_addon_download_result' class='logo_button'><img alt='' src='"+window.browser.runtime.getURL("img/download-1.svg")+"'/><span>Ergebnisse herunterladen</span></button><button id='usability_testing_addon_end_test' class='logo_button'><img alt='' src='"+window.browser.runtime.getURL("img/cancel.svg")+"'/><span>Usability Test beenden</span></button></div><span id='usability_testing_addon_cancel' style='padding: 6px 7px !important; z-index: 16777271 !important; position: fixed !important; text-align: right !important; width: 50px !important; height: 50px !important; top: 15px !important; right: 30px !important; font-size: 50px !important;' >X</span></div>").appendTo("body")}$("#usability_testing_addon_overlay_toast").click(function(){$(this).attr("style","transform: scale(0) !important; opacity: 0 !important")}),$("#usability_testing_addon_download_result").click(function(){a("download")}),"none"!==i?$("#usability_testing_addon_send_result_email").click(function(){a("send")}):$("#usability_testing_addon_send_result_email").remove(),$("#usability_testing_addon_end_test").click(function(){removeOverlay()})}window.browser=window.msBrowser||window.browser||window.chrome,window.browser.extension.onRequest.addListener(function(t,e,i){switch(("end"!==t.messageType||!1!==t.first&&void 0!==t.first)&&"getURL"!==t.messageType&&"cancelTask"!==t.messageType&&removeOverlay(),t.messageType){case"start":window.onbeforeunload=function(t){i({task:0})},task_completion_array=new Array(t.taskCount).fill(!1),displayStart(function(){removeOverlay(),i({task:0,tester_id:tester_id})});break;case"reinstate":window.onbeforeunload=function(e){let n=getTimeOffset();("css_id"===t.task.target_type||"both"===t.task.target.target_type&&t.task.target.target_urls.includes(window.location.href))&&$("#"+t.task.target.target_css_ids.join(", #")).unbind("click.usabilityTestHandler"),setTimeout(function(){i({task:-2,timeOffset:n,tester_id:tester_id,current_task:t.task,task_completion_array:task_completion_array})},0)},tester_id=t.tester_id,task_completion_array=t.task_completion_array,current_task=t.task,console.log("abc",task_completion_array,current_task),(t=>t.every(t=>!0===t))(task_completion_array)||task_completion_array[t.task.id]?i():(console.log("got reinstate packet",t.startTime),reinstateTask(t.task,t.timeOffset,t.startTime,function(e,n,a=!1){a?i():((null==n||isNaN(n))&&(n=0),("css_id"===t.task.target_type||"both"===t.task.target.target_type&&t.task.target.target_urls.includes(window.location.href))&&$("#"+t.task.target.target_css_ids.join(", #")).unbind("click.usabilityTestHandler"),removeOverlay(),console.log("12345"),i({currenttask:t.task,task:-3,success:e,timeTaken:n}))}));break;case"task":task_completion_array=t.task_completion_array,window.onbeforeunload=function(e){let n=getTimeOffset();i({task:-2,timeOffset:n,tester_id:tester_id,current_task:t.task,task_completion_array:task_completion_array})},current_task=t.task,displayTask(t.task,t.startTime,function(e,n,a=!1){a?i():(window.browser.runtime.sendMessage({reason:"endCountdown"},function(t){}),(null==n||isNaN(n))&&(n=0),("css_id"===t.task.target_type||"both"===t.task.target.target_type&&t.task.target.target_urls.includes(window.location.href))&&$("#"+t.task.target.target_css_ids.join(", #")).unbind("click.usabilityTestHandler"),$(".usability_testing_addon_cancel_task").remove(),i({currenttask:t.task,task:-3,success:e,timeTaken:n}))});break;case"displayTaskResult":displayTaskResult(t.task,t.success,t.timeTaken,function(e,n=!1){n?i():i({currenttask:t.task,task:parseInt(current_task.id)+1,success:t.success,timeTaken:t.timeTaken,comment:e,task_completion_array:task_completion_array})});break;case"cancelTask":let e=$(".usability_testing_addon_cancel_task");0!==e.length&&e.click(),i();break;case"getCSSID":$("body").bind("mousemove.selectTargetHandlerBody",function(t){$(".usability_extension_highlighted").removeClass("usability_extension_highlighted"),$(t.target).addClass("usability_extension_highlighted"),setTimeout(function(){$(".usability_extension_highlighted").bind("click.selectTargetHandler",function(t){for(var e=t.target||t.srcElement,n=!0;e&&!e.id;)n=!1,e=e.parentNode;var a=e.id;$(".usability_extension_highlighted").unbind("click.selectTargetHandler").removeClass("usability_extension_highlighted"),$("body").unbind("mousemove.selectTargetHandlerBody"),n||$("#"+a).addClass("usability_extension_highlighted"),i({id:a,original:n})})},0)});break;case"getURL":i({url:window.location.href});break;case"end":$("#usability_testing_addon_cancel").remove(),displayResults(t.testResults,t.tasks,t.transfer_type,t.first,function(t){i({task:-1,returnVal:t,tester_id:tester_id})}),!0===t.success?displayToast("Ihre Ergebnisse wurden erfolgreich gesendet!","Ihre Testergebnisse wurden erfolgreich an den Ersteller dieses Tests übermittelt. Vielen Dank!",7e3):!1===t.success&&displayToast("Fehler beim Senden des Ergebnisses!","Beim Senden Ihres Ergebnisses an den Ersteller dieses Tests ist ein Fehler aufgetreten. Bitte laden Sie das Ergebnis herunter und senden Sie es manuell!",1e4),window.onbeforeunload=function(t){i()};break;default:alert("unknown request"),i()}});