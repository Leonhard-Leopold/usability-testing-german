var test={test_title:"",tasks:[],transfer_results:{transfer_type:"email",email:"",url:""}},currentState={state:"",task:null,startTime:null},stored_test={},tester_id="",stored_task={id:null,instruction:"",time:null,time_limit_visible:!1,target:{target_type:"url",target_urls:[],target_css_ids:[],message:null}},test_results=[],savedData={};savedData.task_completion_array=new Array(test.tasks.length).fill(!1);var activeTest=!1;function sendToContentScript(t,e){var s=function(t){chrome.runtime.lastError?(console.log("Whoops.. "+chrome.runtime.lastError.message),"Could not establish connection. Receiving end does not exist."===window.browser.runtime.lastError.message&&(window.browser.runtime.sendMessage({reason:"displayMessage",mesTitle:"Ein unerwarteter Fehler ist aufgetreten!",mesBody:"Bitte versuchen Sie es nach erneutem Öffnen des Browser-Plugins und erneutem Laden dieser Website noch einmal!",mesTime:-1},function(t){}),currentState.state="takeTest")):e(t)};window.browser.tabs.getSelected(null,function(e){e.id>=0?window.browser.tabs.sendRequest(e.id,t,s):window.browser.runtime.sendMessage({reason:"displayMessage",mesTitle:"Ein unerwarteter Fehler ist aufgetreten!",mesBody:"Bitte versuchen Sie es nach dem erneuten Öffnen des Browser-Plugins erneut!",mesTime:5e3},function(t){})})}function reinstateListener(t,e,s){if(void 0===savedData.task)return;let a=parseInt(savedData.task.id),r=0;for(let t=0;t<savedData.task_completion_array.length;t++)if(!1===savedData.task_completion_array[t]){r=t;break}console.log(e.status,activeTest,currentState.state,a,r),"complete"===e.status&&activeTest&&"end"!==currentState.state&&(console.log("send reinstate packet",savedData.startTime),sendToContentScript({messageType:"reinstate",task:test.tasks[r],startTime:savedData.startTime,timeOffset:savedData.timeOffset,tester_id:savedData.tester_id,task_completion_array:savedData.task_completion_array},function(t){console.log("56"),console.log("56",t),null!=t&&(console.log("45",t,activeTest,savedData.task_completion_array),-3===t.task&&activeTest&&!savedData.task_completion_array[t.currenttask.id]&&content_script_callback(t))}))}function content_script_callback(t){if(null!=t){let s=t.task;if(s>=test.tasks.length&&activeTest)currentState.state="end",currentState.task=null,currentState.startTime=null,savedData.task_completion_array=t.task_completion_array,$("#takeTest_cancel").css("display","none"),$("#backButton").click(),activeTest=!1,sendToContentScript({messageType:"end",testResults:test_results,tasks:test.tasks,first:!0,transfer_type:test.transfer_results.transfer_type},function(t){content_script_callback(t)});else if(-1===s){currentState={state:"",task:null,startTime:null},$("#takeTest_cancel").css("display","none");var e=[];for(let t=0;t<test_results.length;t++)e.push({task_id:test_results[t].task_id,timeTaken:test_results[t].timeTaken,success:test_results[t].success,comment:test_results[t].comment});let s={test:test,tester_id:tester_id,results:e},a="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s));if("download"===t.returnVal){let t=(""===test.test_title?"test_result":test.test_title+"_result")+".json",e=document.createElement("a");e.setAttribute("href",a),e.setAttribute("download",t),e.click(),sendToContentScript({messageType:"end",testResults:test_results,tasks:test.tasks,first:!1,transfer_type:test.transfer_results.transfer_type},function(t){content_script_callback(t)})}else"send"===t.returnVal?"email"===test.transfer_results.transfer_type?$.ajax({url:"http://homepage-allupp.bplaced.net/test/usabilityTest/sendmail.php",type:"post",success:function(t){sendToContentScript({messageType:"end",testResults:test_results,tasks:test.tasks,first:!1,transfer_type:test.transfer_results.transfer_type,success:!0},function(t){content_script_callback(t)})},error:function(t,e,s){sendToContentScript({messageType:"end",testResults:test_results,tasks:test.tasks,first:!1,transfer_type:test.transfer_results.transfer_type,success:!1},function(t){content_script_callback(t)})},data:{email:test.transfer_results.email,test_title:test.test_title,tester_id:s.tester_id,result:JSON.stringify(s)}}):"url"===test.transfer_results.transfer_type&&$.ajax({url:test.transfer_results.url,type:"post",success:function(t){sendToContentScript({messageType:"end",testResults:test_results,tasks:test.tasks,first:!1,transfer_type:test.transfer_results.transfer_type,success:!0},function(t){content_script_callback(t)})},error:function(t,e,s){sendToContentScript({messageType:"end",testResults:test_results,tasks:test.tasks,first:!1,transfer_type:test.transfer_results.transfer_type,success:!1},function(t){content_script_callback(t)})},data:{test_title:test.test_title,tester_id:s.tester_id,result:JSON.stringify(s)}}):tester_id="";activeTest=!1}else if(-2===s&&activeTest){savedData.task=t.current_task,savedData.tester_id=t.tester_id,savedData.timeOffset=t.timeOffset,(t=>t.every(t=>!0===t))(savedData.task_completion_array)||window.browser.tabs.onUpdated.addListener(reinstateListener)}else-3===s&&activeTest?(currentState.state="task",currentState.task=test.tasks[s],console.log("123",t),sendToContentScript({messageType:"displayTaskResult",task:t.currenttask,success:t.success,timeTaken:t.timeTaken},function(t){if(null!=t&&-2!==t.task){let e=!0,s=t.currenttask.id;for(let t=0;t<test_results.length;t++)test_results[t].task_id!==s&&""!==s&&null!=s||(e=!1);savedData.task_completion_array[s]=!0,e&&test_results.push({task_id:s,task:test.tasks[s].instruction,timeLimit:test.tasks[s].timeLimit,timeTaken:t.timeTaken,success:t.success,comment:t.comment}),content_script_callback(t)}})):activeTest&&(currentState.state="task",currentState.task=test.tasks[s],void 0!==t.task_completion_array&&(savedData.task_completion_array=t.task_completion_array),sendToContentScript({messageType:"task",task:test.tasks[s],timeOffset:savedData.timeOffset,startTime:savedData.startTime,tester_id:savedData.tester_id,task_completion_array:savedData.task_completion_array},function(t){console.log("57"),console.log("57",t),null!=t&&-3===t.task&&activeTest&&!savedData.task_completion_array[t.currenttask.id]&&content_script_callback(t)}))}}window.browser=window.msBrowser||window.browser||window.chrome,window.browser.tabs.onUpdated.addListener(reinstateListener),window.browser.runtime.onMessage.addListener(function(t,e,s){if("startTest"===t.message)test_results=[],currentState.state="start",savedData.task_completion_array=new Array(test.tasks.length).fill(!1),savedData.task=0,savedData.timeOffset=0,currentState.startTime=new Date,activeTest=!0,sendToContentScript({messageType:"start",taskCount:(test=t.test).tasks.length},function(t){tester_id=t.tester_id,window.browser.tabs.onUpdated.addListener(reinstateListener),savedData.task_completion_array=new Array(test.tasks.length).fill(!1),savedData.task=0,savedData.timeOffset=0,currentState.startTime=new Date,content_script_callback(t)});else if("getCSSID"===t.message){let e=t.counter-1;sendToContentScript({messageType:"getCSSID"},function(t){t.original?stored_task.target.message="Das Element mit der CSS-ID #"+t.id+" wurde gewählt!":stored_task.target.message="Das ausgewählte Element hat keine CSS-ID! Das nächste übergeordnete Element mit einer ID (#"+t.id+")  wurde stattdessen gewählt! Bei Verwendung von #"+t.id+" als Ziel, sind alle seine untergeordneten Elemente Ziele. Wenn Sie das ursprünglich ausgewählte Element als Ziel verwenden möchten, überlegen Sie, ihm eine eindeutige CSS-ID zu geben!",stored_task.target.target_css_ids.length<=e?stored_task.target.target_css_ids.push(t.id):stored_task.target.target_css_ids[e]=t.id})}else if("getURL"===t.message){let e=t.counter;sendToContentScript({messageType:"getURL"},function(t){window.browser.runtime.sendMessage({reason:"getURL",url:t.url,counter:e},function(t){})})}else"storeState"===t.message?(stored_test=t.current_test,stored_task=t.current_task):"restoreState"===t.message?currentState.state=t.page:"getState"===t.message?window.browser.runtime.sendMessage({reason:"updateState",state:currentState.state,task:currentState.task,stored_test:stored_test,stored_task:stored_task,startTime:currentState.startTime},function(t){stored_task.target.message=null}):"endCountdown"===t.reason?(currentState.startTime=null,savedData.startTime=null,!0===t.cancelTest&&(currentState.state="end",currentState.task=null,currentState.startTime=null,savedData.task_completion_array=new Array(test.tasks.length).fill(!1),console.log("ended Countdown",savedData.startTime))):"startCountdown"===t.reason&&(currentState.startTime=new Date,savedData.startTime=new Date,console.log("started Countdown",savedData.startTime));s()});