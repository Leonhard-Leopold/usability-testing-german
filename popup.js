var countdown_timeout,test={test_title:"",tasks:[],transfer_results:{transfer_type:"email",email:"",url:""}},useTimeLimit=!1,task_counter=0,test_results=[],resultfiles=[],resultHTML="",savedData={},color_map={25:"#ffb993",50:"#ffea26",75:"#8bff00",100:"#00ff03"};function sendToContentScript(e,t){window.browser.tabs.getSelected(null,function(s){window.browser.tabs.sendRequest(s.id,e,t)})}function displayToast(e,t,s){$("#toast").html("<h3>"+e+"</h3><p>"+t+"</p>").fadeIn(500),s>0&&setTimeout(function(){$("#toast").fadeOut(500)},s)}function addShake(e){$(".shake").removeClass("shake"),$("#"+e).addClass("shake"),setTimeout(function(){$("#"+e).removeClass("shake")},1e3)}function evalFile(e,t){if(null==e)return $(this).find("p").html("Bitte wählen Sie eine JSON-Datei aus!"),void addShake("drop_zone");let s=e.name;$("#drop_zone > p").html("Ausgewählte Datei: "+s),$("#takeTestButton").css("display","block");var i=new FileReader;i.onload=function(){var e=i.result;if("json"===t||"application/json"===t){let t=JSON.parse(e);"test_title"in t&&"transfer_results"in t&&"tasks"in t&&t.tasks.length>0?test=t:($("#drop_zone > p").html("Die ausgewählte Testdatei ist ungültig!"),addShake("drop_zone"),$("#takeTestButton").css("display","none"))}},i.readAsText(e)}function countdown(){countdown_timeout=setTimeout(function(){let e=parseInt($("#remaining_seconds").html());e>0?($("#remaining_seconds").html(e-1),countdown()):$("#takeTest_cancel").css("display","none")},1e3)}function evalResultFiles(e){let t=[];if(0!==e.length){for(let s of e)if("application/json"===s.type||"json"===s.name.split(".").pop().toLowerCase()){let e=new Promise(e=>{let t=new FileReader;t.readAsText(s),t.onload=(()=>e(t.result))});t.push(e)}Promise.all(t).then(t=>{let s=[],i=[],a=0;for(let n=0;n<t.length;n++){let r=JSON.parse(t[n]);void 0===r.test?s.push({filename:e[n].name,valid:!1}):void 0===r.test.tasks?s.push({filename:e[n].name,valid:!1}):"test"in r&&"test_title"in r.test&&"transfer_results"in r.test&&"tasks"in r.test&&r.test.tasks.length>0&&"tester_id"in r&&"results"in r&&r.results.length===r.test.tasks.length?(s.push({filename:e[n].name,valid:!0,counter:a}),a++,i.push(r)):s.push({filename:e[n].name,valid:!1})}resultfiles=i,displayResultFileError(s,a),0!==a&&$("#createSummaryButton").css("display","block")})}}function displayResultFileError(e,t){$(".filesDraggedOver").removeClass("filesDraggedOver"),$("#drop_zone_results > p").html("Ziehen Sie mehrere Ergebnisdateien (.json) in diesen Bereich."),$("#drop_zone_results > p").append("<br/><hr style='margin-bottom: 25px'/><br> ").css("margin-bottom","-25px");for(let t=0;t<e.length;t++)e[t].valid?$("#drop_zone_results > p").append("<div class='result_file valid'><button class='remove_result' id='remove_result_"+e[t].counter+"'>x</button><p title='"+e[t].filename+"'>"+e[t].filename+"</p></div>"):(displayToast("Ungültige Dateien","Einige ausgewählte Dateien sind ungültige Ergebnisdateien!",5e3),addShake("drop_zone_results"),$("#drop_zone_results > p").append("<div class='result_file invalid'><button class='remove_result invalid_result' >x</button><p title='"+e[t].filename+"'><strong>Ungültige Datei</strong><br>"+e[t].filename+"</p></div>"));setTimeout(function(){$(".invalid_result").click(function(){$(this).parent().remove()});for(let e=0;e<t;e++)$("#remove_result_"+e).click(function(){resultfiles[e]=null;var t=[];for(let e=0;e<resultfiles.length;e++)null!==resultfiles[e]&&t.push(resultfiles[e]);0===t.length&&$("#createSummaryButton").css("display","none"),$(this).parent().remove()})},0)}function storeCreateTestForm(){let e=$("#instruction").val(),t=$('input[name="target_type"]:checked').val(),s=$("#timeLimit").val();var i=[],a=[],n=document.getElementsByClassName("url_target"),r=document.getElementsByClassName("css_id_target");for(let e=0;e<n.length;e++)""!==n[e].value&&i.push(n[e].value);for(let e=0;e<r.length;e++)""!==r[e].value.split("#").join(" ")&&a.push(r[e].value.split("#").join(" "));let l={target_type:t,target_urls:i,target_css_ids:a},o={id:task_counter,instruction:e,time:s,time_limit_visible:"block"===$("#timeLimitWrapping").css("display"),target:l};window.browser.runtime.sendMessage({message:"storeState",current_test:test,current_task:o})}window.browser=window.msBrowser||window.browser||window.chrome,$(document).ready(function(){function e(){test.tasks.length>0&&($("#created_tasks_header").css("display","block"),$("#created_tasks").css("display","block"));for(let e=0;e<test.tasks.length;e++){test.tasks[e].id=e;var t="";"url"===test.tasks[e].target.target_type?t="URLs: <br/><strong>"+test.tasks[e].target.target_urls.join(", <br/><br/>")+"</strong>":"css_id"===test.tasks[e].target.target_type?t="CSS IDs: <br/><strong>#"+test.tasks[e].target.target_css_ids.join(" <br/><br/>#")+"</strong>":"both"===test.tasks[e].target.target_type&&(t=(0===test.tasks[e].target.target_css_ids.length?"Keine":"CSS IDs: <br/><strong>#"+test.tasks[e].target.target_css_ids.join(" <br/><br/>#"))+"</strong><br/> on these pages:<br/>"+(0===test.tasks[e].target.target_urls.length?"<strong>None":"URLs: <strong><br/>"+test.tasks[e].target.target_urls.join(", <br/><br/>"))+"</strong>"),$("#testTable").css("display","table").append("<tr><td>"+test.tasks[e].instruction+"</td><td>"+t+"</td><td>"+("no_limit"===test.tasks[e].time?"Kein Limit":test.tasks[e].time+" sec")+"</td><td><button class='remove_from_test' id='remove_from_test_"+e+"'><img width='15' src='img/garbage.svg' /></button></td></tr>")}setTimeout(function(){$(".remove_from_test").click(function(){let t=parseInt($(this).attr("id").split("remove_from_test_").join(""));test.tasks.splice(t,1),$(this).parent().parent().remove(),0===test.tasks.length?($("#created_tasks, #created_tasks_header").css("display","none"),$("#testTable").html(" ")):($("#testTable").html(" <tr>\n                        <th>Aufgabe</th>\n                        <th>Ziel</th>\n                        <th>Zeit Limit</th>\n                        <th>Optionen</th>\n                    </tr>"),e())})},0)}$("#browse_result_files").click(function(){$("#file_input_results").click()}),$("#browse_files").click(function(){$("#file_input").click()}),$("#createSummaryButton").click(function(){window.browser.runtime.sendMessage({message:"restoreState",page:"createSummary"}),$("#loadResults").css("display","none"),$("#toast").fadeOut(500);var e=[];for(let t=0;t<resultfiles.length;t++)null!==resultfiles[t]&&e.push(resultfiles[t]);if(0===(resultfiles=e).length)$("#loadResults").css("display","block"),displayToast("Keine Datei ausgewählt","Es wurde keine Ergebnisdatei ausgewählt!",5e3),addShake("drop_zone_results");else{let e=[];var t=[];for(let s=0;s<resultfiles.length;s++){let i=resultfiles[s].test.test_title;e.includes(i)?t[e.indexOf(i)].push(resultfiles[s]):(e.push(i),t.push([resultfiles[s]]))}for(let a=0;a<t.length;a++){var s=t[a],i=[];resultHTML="          <div class='result_test_wrapper'><div>\n       <h1 class='results_test_title'>"+s[0].test.test_title+"</h1>           <hr style='margin-top: 0;' /><h2 class='results_test_overview'>Überblick aller Ergebnisse</h2>\n                <table class='results_test_overview_table'>\n                    <tr><th>Aufgabe</th><th>Erfolgs-rate</th><th>Durchsch-nittszeit <div style='bottom: -2px; right: -4px;' class=\"tooltip right_tooltip\"><img alt=\"i\" src=\"img/info_black.svg\"/>\n                    <span class=\"tooltiptext\">Wenn die Aufgabe erfolgreich abgeschlossen wurde.</span>\n                </div></th></tr>";for(let e=0;e<s[0].test.tasks.length;e++){let successful_tasks = 0;let t={success:0,timeTaken:0};for(let i=0;i<s.length;i++){t.success+=s[i].results[e].success?1:0,t.timeTaken+=s[i].results[e].success?s[i].results[e].timeTaken:0;successful_tasks += s[i].results[e].success?1:0;}t.success=Math.round(t.success/s.length*100),t.timeTaken=Math.round(t.timeTaken/successful_tasks*100)/100,resultHTML+="<tr><td>"+s[0].test.tasks[e].instruction+"</td><td>"+t.success+"%</td><td>" + (Number.isNaN(t.timeTaken) ? "-" : t.timeTaken + " s")+"</td></tr>",i.push(t)}resultHTML+=" </table>\n            </div><hr style='margin: 15px 10px 5px 10px;'/><h2 class='results_detail_header'>Kommentare & Analyse jeder Aufgabe</h2><div>";for(let t=0;t<s[0].test.tasks.length;t++){let n="#ff3f3f";Object.keys(color_map).forEach(function(e){i[t].success>=e&&(n=color_map[e])}),resultHTML+='   <div id="overview_task_'+e[a]+"_"+t+'">\n                <button class="accordion inactive">'+s[0].test.tasks[t].instruction+"</button>\n                <div class=\"panel inactive\">\n                    <div><div class='result_success_rate_label_wrapper'><img src='img/bar-chart.svg' alt='' /><label class='result_success_rate_label'>Erfolgs-rate</label></div><div class='result_success_rate_wrapper'><div style='background-color: "+n+"; width: "+i[t].success+"%' class='result_success_rate_loading_bar'>"+i[t].success+"%</div></div>  </div>                 \n                    <p><img class='results_average_time_icon' src='img/watch.svg' alt='' /><label class='results_average_time_label'>Durchschnitts-zeit (falls erfolgreich): </label><label class='results_average_time'>"+(Number.isNaN(i[t].timeTaken) ? "-" : i[t].timeTaken + " Sekunden")+"</label></p>\n                    <hr/><h2 class='result_comments_header'>Kommentare</h2>\n                    <div>\n";let r=0;for(let e=0;e<s.length;e++)void 0!==s[e].results[t].comment&&""!==s[e].results[t].comment&&(r++,resultHTML+="                        <p class='result_comment'><img src='img/chat.svg' alt='' /><strong>"+s[e].tester_id+'</strong> kommentierte: "<strong>\n                        '+s[e].results[t].comment+'"</strong></p>\n');0===r&&(resultHTML+="<p><strong>Keine Kommentare!</strong></p>"),resultHTML+="                    </div><hr style='margin-top: 25px;'/>\n                </div>\n            </div>"}resultHTML+="</div></div>",$("#displayResults").css("display","block").prepend(resultHTML)}setTimeout(function(){for(var e=document.getElementsByClassName("accordion"),t=0;t<e.length;t++)e[t].addEventListener("click",function(){this.classList.toggle("active"),this.classList.toggle("inactive"),$(this).parent().find(".panel").toggleClass("active"),$(this).parent().find(".panel").toggleClass("inactive");var e=this.nextElementSibling;e.style.maxHeight?e.style.maxHeight=null:e.style.maxHeight=e.scrollHeight+"px"})},100)}}),$("#download_results").click(function(){var e=document.getElementById("displayResults");let t=[];$(".accordion, .panel").addClass("no_transition"),$(".tooltip").css("display","none"),$("#displayResults").css("padding-top","125px"),$("#download_results").css("display","none"),$(".accordion").each(function(){t.push($(this).hasClass("active")),$(this).hasClass("inactive")&&$(this).click()}),html2pdf().from(e).save().then(function(){$(".accordion").each(function(e){!1===t[e]&&$(this).click()}),$("#displayResults").css("padding-top","15px"),$(".no_transition").removeClass("no_transition"),$(".tooltip").css("display","inline-block"),$("#download_results").css("display","block")})}),$("#test_title").change(function(){test.test_title=$(this).val(),storeCreateTestForm()}),$("#test_email").change(function(){test.transfer_results.email=$(this).val(),storeCreateTestForm()}),$("#test_url").change(function(){test.transfer_results.url=$(this).val(),storeCreateTestForm()}),$("#transfer_method_email").click(function(){test.transfer_results.transfer_type="email",$("#test_email").css("display","inline-block"),$("#test_url").css("display","none"),storeCreateTestForm()}),$("#transfer_method_none").click(function(){test.transfer_results.transfer_type="none",$("#test_email").css("display","none"),$("#test_url").css("display","none"),storeCreateTestForm()}),$("#backButton").click(function(){$("section").css("display","none"),$("main").css("display","block"),window.browser.runtime.sendMessage({message:"restoreState",page:"none"})}),$("#about_link").click(function(){$("#about").css("display","block"),$("main").css("display","none"),window.browser.runtime.sendMessage({message:"restoreState",page:"about"})}),$("#transfer_method_url").click(function(){test.transfer_results.transfer_type="url",$("#test_email").css("display","none"),$("#test_url").css("display","inline-block"),storeCreateTestForm()}),$("#addTimeLimit").click(function(){useTimeLimit?($("#timeLimitWrapping").css("display","none"),useTimeLimit=!1):($("#timeLimitWrapping").css("display","block"),useTimeLimit=!0),storeCreateTestForm()}),$("#createTestButton").click(function(){$("#createTest").css("display","block"),$("main").css("display","none"),window.browser.runtime.sendMessage({message:"restoreState",page:"createTest"}),storeCreateTestForm()}),$("#loadTestButton").click(function(){$("#loadTest").css("display","block"),$("main").css("display","none"),window.browser.runtime.sendMessage({message:"restoreState",page:"takeTest"})}),$("#loadResultsButton").click(function(){$("#loadResults").css("display","block"),$("main").css("display","none"),window.browser.runtime.sendMessage({message:"restoreState",page:"createSummary"})}),$("#takeTestButton").click(function(){window.browser.runtime.sendMessage({message:"startTest",test:test}),$("#takeTest_instruction").html("<h2>Drücken Sie den Button zum Fortfahren!</h2>"),$("#takeTest").css("display","block"),$("#loadTest").css("display","none")}),$("#url").click(function(){$("#url_target_wrapper").css("display","block"),$("#css_id_target_wrapper").css("display","none"),$("#separator").css("display","none"),storeCreateTestForm()}),$("#toast").click(function(){$(this).fadeOut(500)}),$("#css_id").click(function(){$("#url_target_wrapper").css("display","none"),$("#css_id_target_wrapper").css("display","block"),$("#separator").css("display","none"),storeCreateTestForm()}),$("#both").click(function(){$("#url_target_wrapper").css("display","block"),$("#css_id_target_wrapper").css("display","block"),$("#separator").css("display","block"),storeCreateTestForm()}),$("#instruction, .url_target, .css_id_target, #timeLimit").change(function(){storeCreateTestForm()}),$("#add_url").click(function(){let e=document.getElementsByClassName("url_target").length+1;$("#url_target_wrapper > div").append('<input placeholder="URL" type="text" id="url_target_'+e+'" class="url_target"/>\n<button type="button"  id="use_url_target_'+e+'">Aktuelle URL</button>'),setTimeout(function(){$("#use_url_target_"+e).click(function(){window.browser.runtime.sendMessage({message:"getURL",counter:e})}),$(".url_target").change(function(){storeCreateTestForm()})},0)}),$("#add_css_id").click(function(){let e=document.getElementsByClassName("css_id_target").length+1;$("#css_id_target_wrapper > div").append('<input placeholder="CSS ID" type="text" id="css_id_target_'+e+'" class="css_id_target"/>\n<button type="button"  id="use_css_id_target_'+e+'">Ziel wählen</button>'),setTimeout(function(){$("#use_css_id_target_"+e).click(function(){window.browser.runtime.sendMessage({message:"getCSSID",counter:e})}),$(".css_id_target").change(function(){storeCreateTestForm()})},0)}),$("#use_css_id_target_1").click(function(){window.browser.runtime.sendMessage({message:"getCSSID",counter:1})}),$("#use_url_target_1").click(function(){window.browser.runtime.sendMessage({message:"getURL",counter:1})}),$("#download_json").click(function(){if("email"===test.transfer_results.transfer_type&&""===test.transfer_results.email)return displayToast("Keine E-Mail Addresse","Bitte geben Sie eine E-Mail-Adresse an, an der Sie die Testergebnisse erhalten möchten!",5e3),void addShake("general_information");if("url"===test.transfer_results.transfer_type&&""===test.transfer_results.url)return displayToast("Keine URL spezifiziert","Bitte geben Sie eine URL ein, unter der Sie die Testergebnisse erhalten möchten!",5e3),void addShake("general_information");if(""===test.test_title)return displayToast("Kein Test-Titel spezifiziert","Bitte geben Sie einen gültigen Test-Titel ein!",5e3),void addShake("general_information");if(0===test.tasks.length)return displayToast("Keine Tasks spezifiziert","Bitte fügen Sie dem Test mindestens eine Aufgabe hinzu!",5e3),void addShake("create_new_task");let e="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(test)),t=(""===test.test_title?"data":test.test_title)+".json",s=document.createElement("a");s.setAttribute("href",e),s.setAttribute("download",t),s.click()}),$("#addToTest").click(function(){let t=$("#instruction").val(),s=$('input[name="target_type"]:checked').val(),i=$("#timeLimit").val();var a=[],n=[],r=document.getElementsByClassName("url_target"),l=document.getElementsByClassName("css_id_target");for(let e=0;e<r.length;e++)""!==r[e].value&&a.push(r[e].value);for(let e=0;e<l.length;e++)""!==l[e].value.split("#").join(" ")&&n.push(l[e].value.split("#").join(" "));if(!1!==useTimeLimit&&""!==i||(i="no_limit"),""===t)return displayToast("Keine Aufgabe spezifiziert","Bitte geben Sie eine Anweisung für den Tester ein!",5e3),void addShake("create_new_task");if(("css_id"===s||"both"===s)&&0===n.length)return displayToast("Keine CSS ID spezifiziert","Bitte geben Sie mindestens eine CSS-ID ein!",5e3),void addShake("create_new_task");if(("url"===s||"both"===s)&&0===a.length)return displayToast("Keine URL spezifiziert","Bitte geben Sie mindestens eine URL ein!",5e3),void addShake("create_new_task");$("#created_tasks, #created_tasks_header").css("display","block");let o={id:task_counter,instruction:t,time:i,target:{target_type:s,target_urls:a,target_css_ids:n}};test.tasks.push(o),task_counter++,$("#testTable").html(" <tr>\n                        <th>Aufgabe</th>\n                        <th>Ziel</th>\n                        <th>Zeit Limit</th>\n                        <th>Optionen</th>\n                    </tr>"),e(),storeCreateTestForm()}),$("#file_input").change(function(e){let t,s=e.target.files;for(let e=0;e<s.length;e++){var i=s[e].type;if("application/json"===i){t=s[e];break}}evalFile(t,i)}),$("#takeTest_cancel").click(function(){$(this).css("display","none"),clearTimeout(countdown_timeout),sendToContentScript({messageType:"cancelTask"},function(e){})}),$("#file_input_results").change(function(e){evalResultFiles(e.target.files)}),$("#drop_zone, #drop_zone_results").on("dragover",function(e){$(this).addClass("filesDraggedOver"),e.preventDefault(),e.stopPropagation()}).on("dragleave",function(e){$(this).removeClass("filesDraggedOver"),e.preventDefault(),e.stopPropagation()}).on("drop",function(e){if(e.preventDefault(),e.stopPropagation(),e=e.originalEvent,"drop_zone"===$(this).attr("id")){let s=null;for(let i=0;i<e.dataTransfer.items.length;i++){var t=e.dataTransfer.files[i].name.split(".").pop().toLowerCase();if("file"===e.dataTransfer.items[i].kind&&t){s=e.dataTransfer.files[i];break}}evalFile(s,t)}else evalResultFiles(e.dataTransfer.files)}),window.browser.runtime.onMessage.addListener(function(t,s,i){if("startCountdown"===t.reason)countdown(),$("#takeTest_cancel").css("display","block"),i();else if("endCountdown"===t.reason)clearTimeout(countdown_timeout),$("#takeTest_cancel").css("display","none"),$("#takeTest_instruction > p").html("Time is up!"),i();else if("getURL"===t.reason)$("#url_target_"+t.counter).val(t.url),storeCreateTestForm(),i();else if("updateState"===t.reason){if(void 0!==t.stored_task&&void 0!==t.stored_task.target){let e=t.stored_task;$("#instruction").val(e.instruction),$("#timeLimit").val(parseInt(e.time)),e.time_limit_visible?$("#timeLimitWrapping").css("display","block"):$("#timeLimitWrapping").css("display","none"),useTimeLimit=e.time_limit_visible,$("#"+e.target.target_type).click();let s=e.target.target_urls;for(let e=0;e<s.length;e++)0!==e?($("#url_target_wrapper > div").append('<input placeholder="URL" type="text" value=\''+s[e]+"' id=\"url_target_"+(e+1)+'" class="url_target"/>\n<button type="button"  id="use_url_target_'+(e+1)+'">Aktuelle URL</button>'),setTimeout(function(){$("#use_url_target_"+(e+1)).click(function(){window.browser.runtime.sendMessage({message:"getURL",counter:e+1})}),$(".url_target").change(function(){storeCreateTestForm()})},0)):$("#url_target_1").val(s[0]);let i=e.target.target_css_ids;for(let e=0;e<i.length;e++)0!==e?($("#css_id_target_wrapper > div").append('<input placeholder="CSS ID" type="text" value=\''+i[e]+"' id=\"css_id_target_"+(e+1)+'" class="css_id_target"/>\n<button type="button"  id="use_css_id_target_'+(e+1)+'">Ziel wählen</button>'),setTimeout(function(){$("#use_css_id_target_"+(e+1)).click(function(){window.browser.runtime.sendMessage({message:"getCSSID",counter:e+1})}),$(".css_id_target").change(function(){storeCreateTestForm()})},0)):$("#css_id_target_1").val(i[0]);null!==e.target.message&&void 0!==e.target.message&&displayToast("Info über das ausgewählte Element!",e.target.message,-1)}if(void 0!==t.stored_test&&void 0!==t.stored_test.tasks&&(task_counter=t.stored_test.tasks.length,test=t.stored_test,$("#test_title").val(test.test_title),$("#transfer_method_"+test.transfer_results.transfer_type).click(),$("#test_url").val(test.transfer_results.url),$("#test_email").val(test.transfer_results.email),e()),"task"===t.state)if($("#takeTest").css("display","block"),$("main").css("display","none"),clearTimeout(countdown_timeout),$("#takeTest_cancel").css("display","block"),"no_limit"!==t.task.time){endTime=new Date;let e=new Date(t.startTime);var a=endTime-e;a/=1e3;let s=Math.round(t.task.time-a);$("#takeTest_instruction").html("<h2> "+t.task.instruction+"</h2><p  class='countdown'>Sie haben <span id='remaining_seconds'>"+(s>=0?s:0)+"</span> Sekunden, um die Aufgabe abzuschließen.</p>"),countdown()}else $("#takeTest_instruction").html("<h2>"+t.task.instruction+"</h2><p class='countdown'>Sie haben kein Zeitlimit für die Erledigung der Aufgabe.</p>");else"start"===t.state?($("#takeTest").css("display","block"),$("main").css("display","none")):"end"===t.state?($("#takeTest").css("display","block"),$("main").css("display","none"),$("#takeTest_cancel").css("display","none"),$("#backButton").click(),clearTimeout(countdown_timeout)):"createTest"===t.state?($("#createTest").css("display","block"),$("main").css("display","none")):"createSummary"===t.state?($("#loadResults").css("display","block"),$("main").css("display","none")):"takeTest"===t.state?($("#loadTest").css("display","block"),$("main").css("display","none")):"about"===t.state?($("#about").css("display","block"),$("main").css("display","none")):""!==t.state&&"none"!==t.state&&void 0!==t.state&&($("#takeTest").css("display","block"),$("main").css("display","none"));i()}else"displayMessage"===t.reason?(displayToast(t.mesTitle,t.mesBody,t.mesTime),i()):i()}),window.browser.runtime.sendMessage({message:"getState"})});